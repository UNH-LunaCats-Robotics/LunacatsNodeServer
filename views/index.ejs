<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Lunacats</title>
    <link rel="stylesheet" type="text/css" href="css/style.css">


    <script>
    //Commands and the numbers they're represented as
const forwardCmd = 0;
const backCmd = 1;
const leftCmd = 2;
const rightCmd = 3;
const stopCmd = 4;
const getPixyInfoCmd = 5;
const getLidarInfoCmd = 6;

//TODO: Implement these on raspberry Pi
const startAutoCmd    = 7;
const stopAutoCmd     = 8;

//Ip address that the program connects to
const ip = "http://10.0.10.10:5000"

//Standard power assigned to each motor
const buttonPower = -10;

//This creates the json string for a drive command with a given ammount of power
function createDriveCommandWithPower (cmd, power) {
  return ip+"/cmd/{'c':"+cmd+",'p':"+power+"}";
}
//This creates the json string for a drive command with a standard ammount of power
function createDriveCommand (cmd) {
  return createDriveCommandWithPower(cmd,buttonPower)
}

//This sends the json to the raspberry pi and gets a response
async function sendJson(json){
  console.log("Sent:\t"+json);
  const response = fetch(json, {mode: 'cors'});
  console.log("Got:\t"+response);
  return response;
}

//This sends a drive command with a standard ammount of power to the robot
function sendDriveCommand (cmd) {
  return sendJson(createDriveCommand(cmd))
}
//This sends a json string with just a cmd specified to the robot
function sendCmd(cmd) {
  return sendJson(ip+"/cmd/{'c':"+cmd+"}");
}

//These are used by the buttons in drivePage.html
const forward = async () => {
    const myJson = await sendDriveCommand(forwardCmd)
}
const back = async () => {
    const myJson = await sendDriveCommand(backCmd)
}
const left = async () => {
    const myJson = await sendDriveCommand(leftCmd)
}
const right = async () => {
    const myJson = await sendDriveCommand(rightCmd)
}
const stop = async () => {
    const myJson = await sendDriveCommand(stopCmd)
}

const startAuto = async () => {
    const myJson = await sendCmd(startAutoCmd)
}
const stopAuto = async () => {
    const myJson = await sendCmd(stopAutoCmd)
}





//This sets up the pixy view
setInterval( loadPixy = async () => {

    const response = await sendCmd(getPixyInfoCmd);

    const myJson = response.json(); //extract JSON from the http response

    console.log("Got:"+myJson);
    const count = myJson["C"];

    const pixyView = document.getElementById('pixyViewBox');

    pixyView.innerHTML = '';

    for(i = 0; i < count; i++) {
        const width  = myJson["W"+i]/320;
        const height = myJson["H"+i]/200;

        const x = myJson["X"+i]/320 - width/2;
        const y = myJson["Y"+i]/200 - height/2;

        const box = document.createElement("DIV");
        box.setAttribute("class","pixyImg");


        // <div id = "sig 1" class="pixyImg" style="width: 50px; height: 50px;"></div>
        box.setAttribute("style",
            "width: "+width*100+"%;" +
            " height: "+height*100+"%;" +
            " left:"+x*100+"%;" +
            " top:"+y*100+"%;");

        box.innerHTML = myJson["S"+i];

        pixyView.appendChild(box);
    }


},5000);
//This gets the lidar distance from the robot
const loadLidar = async () => {
    const response = await sendCmd(getLidarInfoCmd);
    const myJson = await response.json(); //extract JSON from the http response

    const dist = myJson["L"];

    document.getElementById("lidarDistance").setAttribute("value",dist);

}

        function startup() {
            setInterval(loadLidar,500);
            setInterval(loadPixy,500);
        }
        window.onload = startup;
    </script>
</head>

<body style="overflow: hidden;">

<div id = "feedbackBox">
    <div id = "map">
        <header> Lidar </header>
        <p style="margin: 0; color: black;"> Front Left Wheel </p>
        <progress value="0" max="7" id="lidarDistance" style="width: 100%;"> </progress>
        <p style="margin: 0; color: black;"> Front Right Wheel </p>
        <progress value="0" max="7" id="lidarDistance" style="width: 100%;"> </progress>
        <p style="margin: 0; color: black;"> Back Left Wheel </p>
        <progress value="0" max="7" id="lidarDistance" style="width: 100%;"> </progress>
        <p style="margin: 0; color: black;"> Back Right Wheel </p>
        <progress value="0" max="7" id="lidarDistance" style="width: 100%;"> </progress>


    </div>
    <div id = "pixyView">
        <header> Pixy View </header>
        <div width="100%" height="90%" id="pixyViewBox">
        </div>
    </div>


</div>


<table id="controlAugur" align="center">
    <tr>
        <td></td>
        <td align="center"><button type="button" onclick="stop()" class="sendJson">Raise</button></td>
        <td></td>
    </tr>
    <tr>
        <td></td>
        <td align="center"><button type="button" onclick="stop()" class="sendJson">Lower</button></td>
        <td></td>
    </tr>
    <tr>
        <td></td>
        <td align="center"><button type="button" onclick="stop()" class="sendJson">Drill</button></td>
        <td></td>
    </tr>
</table>

<table id="moveButtons" align="center">
    <tr>
        <td></td>
        <td align="center"><button type="button" onclick="forward()" class="sendJson">Forward</button></td>
        <td></td>
    </tr>
    <tr>
        <td align="center"><button type="button" onclick="left()" class="sendJson">Left</button></td>
        <td align="center"><button type="button" onclick="stop()" class="sendJson">Stop</button></td>
        <td align="center"><button type="button" onclick="right()"class="sendJson">Right</button></td>
    </tr>
    <tr>
        <td></td>
        <td align="center"><button type="button" onclick="back()" class="sendJson">Back</button></td>
        <td></td>
    </tr>

</table>

<table id="autoButtons" align="center">
    <tr>
        <td></td>
        <td align="center"><button type="button" onclick="startAuto()" class="sendJsonBlue">Start Auto</button></td>
        <td></td>
    </tr>
    <tr>
        <td></td>
        <td align="center"><button type="button" onclick="stopAuto()" class="sendJsonRed">Stop Auto</button></td>
        <td></td>
    </tr>
</table>




</body>
</html>
